<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Dist. Castillo</title>
    <!-- CORRECCIÓN CORS: Usar archivo local en lugar de CDN para soporte offline real -->
    <script src="tailwind.js"></script> 
    <!-- Fallback si no tienes el archivo local aún -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- LIBRERÍAS EXCEL (Esenciales para CXC y Data) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <meta name="theme-color" content="#3b82f6"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background-image: url('images/fondo.png');
            background-size: cover;
            background-position: center;
            filter: blur(3px) brightness(0.6);
            transition: background-image 0.5s ease-in-out;
        }
        body.catalogo-active::before {
            background-image: var(--catalogo-bg-image, url('images/fondo.png'));
        }
        .hidden {
            display: none;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .autocomplete-list {
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            width: 100%;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem; 
        }
        .autocomplete-item:hover, .autocomplete-item.selected { 
            background-color: #f1f5f9;
        }
        input[type="checkbox"]#offline-toggle {
            height: 0;
            width: 0;
            visibility: hidden;
        }
        label[for="offline-toggle"] {
            cursor: pointer;
            text-indent: -9999px;
            width: 50px; 
            height: 25px; 
            background: grey;
            display: block;
            border-radius: 100px;
            position: relative;
        }
        label[for="offline-toggle"]:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px; 
            height: 21px;
            background: #fff;
            border-radius: 90px;
            transition: 0.3s;
        }
        input:checked + label[for="offline-toggle"] {
            background: #dc2626; 
        }
        input:checked + label[for="offline-toggle"]:after {
            left: calc(100% - 2px);
            transform: translateX(-100%);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-100"> 
    <div id="app" class="flex flex-col min-h-screen">
        <main id="mainContent" class="flex-grow hidden">
        </main>

        <!-- Contenido de Login -->
        <main id="loginContent" class="flex-grow flex items-center justify-center p-4">
            <div class="bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dist. Castillo</h1>
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="emailInput" placeholder="Email" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="passwordInput" placeholder="Contraseña" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300 transform hover:scale-105">
                        Ingresar
                    </button>
                    <p id="authMessage" class="text-sm text-red-500 mt-2 h-4"></p> 
                </form>
                 <p class="mt-6 text-sm text-gray-800">
                    ¿No tienes una cuenta?
                    <button id="goToRegisterBtn" class="font-semibold text-blue-600 hover:underline">Regístrate aquí</button>
                </p>
            </div>
        </main>

        <!-- Contenido de Registro -->
        <main id="registerContent" class="flex-grow flex items-center justify-center p-4 hidden">
            <div class="bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-xl text-center max-w-sm w-full">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Crear Cuenta</h1>
                <form id="registerForm" class="space-y-4">
                    <input type="email" id="registerEmailInput" placeholder="Email" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="registerPasswordInput" placeholder="Contraseña (mín. 6)" required minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="confirmPasswordInput" placeholder="Confirmar Contraseña" required minlength="6"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-105">
                        Registrar
                    </button>
                    <p id="registerMessage" class="text-sm text-red-500 mt-2 h-4"></p> 
                </form>
                <p class="mt-6 text-sm text-gray-800">
                    ¿Ya tienes una cuenta?
                    <button id="goToLoginBtn" class="font-semibold text-blue-600 hover:underline">Inicia sesión</button>
                </p>
            </div>
        </main>

        <!-- Modal Universal -->
        <div id="modalContainer" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden animate-fade-in p-4">
            <div id="modalContent" class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            </div>
        </div>

        <!-- Controles Flotantes -->
        <div id="floating-controls" class="fixed bottom-4 right-4 space-y-2 z-40 hidden">
             <span id="connectionStatusFloating" class="block text-xs font-bold px-3 py-2 rounded-full shadow-lg transition-colors duration-300 bg-gray-200 text-gray-600">Conectando...</span>
            <button id="logoutBtn" class="w-12 h-12 bg-red-500 text-white font-semibold rounded-full shadow-lg hover:bg-red-600 transition duration-300 flex items-center justify-center transform hover:scale-110" title="Cerrar Sesión">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- 1. IMPORTAR CONFIGURACIÓN GLOBAL (Debe ir antes de los módulos) -->
    <script src="config.js"></script>

    <!-- Importar módulos locales -->
    <script src="data.js" defer></script>
    <script src="admin.js" defer></script>
    <script src="inventario.js" defer></script>
    <script src="catalogo.js" defer></script>
    <script src="clientes.js" defer></script>
    <script src="ventas-ui.js" defer></script>
    <script src="ventas.js" defer></script>
    <script src="obsequios.js" defer></script>
    <script src="edit-inventario.js" defer></script> 
    <script src="cxc.js" defer></script>

    <script type="module"> 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // 1. CORRECCIÓN: Importar initializeFirestore y persistentLocalCache
        import { 
            getFirestore, 
            doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, writeBatch, runTransaction, getDocs, 
            query, where, orderBy, limit, startAfter, enableNetwork, disableNetwork, increment,
            initializeFirestore, persistentLocalCache 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. VERIFICACIÓN DE CONFIGURACIÓN Y CARGA CENTRALIZADA
        if (!window.AppConfig) {
            console.error("CRITICAL ERROR: config.js no se ha cargado.");
            alert("Error de Sistema: No se pudo cargar la configuración. Verifique que 'config.js' existe y se carga correctamente.");
        }

        const firebaseConfig = window.AppConfig.firebaseConfig;
        const appId = firebaseConfig.projectId;

        let db, auth, userId;
        window.userRole = 'user'; 
        let activeListeners = [];
        window.isLoggingOut = false; 
        window.TIPOS_VACIO_GLOBAL = ["1/4 - 1/3", "ret 350 ml", "ret 1.25 Lts"];
        let manualOffline = localStorage.getItem('manualOfflineMode') === 'true';

        const mainContent = document.getElementById('mainContent');
        const modalContainer = document.getElementById('modalContainer');
        const modalContent = document.getElementById('modalContent');
        const loginForm = document.getElementById('loginForm');
        const authMessage = document.getElementById('authMessage');
        const loginContent = document.getElementById('loginContent');
        const registerContent = document.getElementById('registerContent');
        const registerForm = document.getElementById('registerForm');
        const registerMessage = document.getElementById('registerMessage');
        const floatingControls = document.getElementById('floating-controls');
        const connectionStatusEl = document.getElementById('connectionStatusFloating');

        // --- LÓGICA DE CONEXIÓN CENTRALIZADA ---
        function updateConnectionDisplay(isOnline) {
            if (!connectionStatusEl) return;
            
            // Prioridad a modo manual
            if (manualOffline) {
                connectionStatusEl.textContent = "OFFLINE (MANUAL)";
                connectionStatusEl.className = "block text-xs font-bold px-3 py-2 rounded-full shadow-lg transition-colors duration-300 bg-red-600 text-white";
                return;
            }

            if (isOnline) {
                connectionStatusEl.textContent = "EN LÍNEA";
                connectionStatusEl.className = "block text-xs font-bold px-3 py-2 rounded-full shadow-lg transition-colors duration-300 bg-green-500 text-white";
            } else {
                connectionStatusEl.textContent = "SIN CONEXIÓN";
                connectionStatusEl.className = "block text-xs font-bold px-3 py-2 rounded-full shadow-lg transition-colors duration-300 bg-yellow-400 text-yellow-900 animate-pulse";
            }
        }

        // Listeners inmediatos del navegador (Feedback rápido)
        window.addEventListener('online', () => updateConnectionDisplay(true));
        window.addEventListener('offline', () => updateConnectionDisplay(false));
        // Estado inicial
        updateConnectionDisplay(navigator.onLine);

        // Función Modal Global
        window.showModal = function(title, message, onConfirm = null, confirmText = 'Confirmar', onCancel = null, triggerConfirmLogic = false) {
            modalContent.innerHTML = `
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>
                    <div class="text-gray-600 mb-6 text-sm md:text-base">${message}</div>
                    <div class="flex flex-col sm:flex-row justify-center gap-3 mt-6">
                        <button id="closeModalBtn" class="w-full sm:w-auto px-5 py-2.5 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-200">Cerrar</button>
                        ${onConfirm ? `<button id="confirmBtn" class="w-full sm:w-auto px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200">${confirmText}</button>` : ''}
                    </div>
                </div>
            `;

            const closeModal = () => {
                modalContainer.classList.add('hidden');
                if (onCancel) onCancel();
            };

            document.getElementById('closeModalBtn')?.addEventListener('click', closeModal);

            if (onConfirm) {
                const confirmBtn = document.getElementById('confirmBtn');
                confirmBtn.addEventListener('click', async () => {
                    if (triggerConfirmLogic) {
                        confirmBtn.disabled = true;
                        confirmBtn.textContent = 'Procesando...';
                        await onConfirm();
                    } else {
                        onConfirm();
                    }
                    closeModal();
                });
            }
            modalContainer.classList.remove('hidden');
        };

        // Función para Agregar Items Rápidos
        window.showAddItemModal = async function(collectionName, itemName) {
            modalContent.innerHTML = `
                <div class="text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Nuevo ${itemName}</h3>
                    <form id="addItemForm" class="space-y-4">
                        <input type="text" id="newItemInput" placeholder="Nombre del ${itemName}" class="w-full px-4 py-2 border rounded-lg" required>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg">Agregar</button>
                    </form>
                    <p id="addItemMessage" class="text-sm mt-2 h-4"></p>
                    <button id="closeItemBtn" class="mt-4 px-4 py-2 bg-gray-400 text-white rounded-lg">Cerrar</button>
                </div>
            `;
            modalContainer.classList.remove('hidden');

            document.getElementById('closeItemBtn').addEventListener('click', () => modalContainer.classList.add('hidden'));

            document.getElementById('addItemForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('newItemInput').value.trim().toUpperCase();
                const msg = document.getElementById('addItemMessage');
                try {
                    // Si la ruta comienza con 'artifacts', usarla tal cual (público), si no, construir ruta de usuario (privado)
                    const colRef = collection(db, collectionName.startsWith('artifacts') ? collectionName : `artifacts/${appId}/users/${userId}/${collectionName}`);
                    
                    await addDoc(colRef, { name });
                    msg.textContent = "¡Agregado con éxito!";
                    msg.className = "text-green-600 text-sm";
                    setTimeout(() => modalContainer.classList.add('hidden'), 1000);
                } catch (err) {
                    console.error(err);
                    msg.textContent = "Error al guardar.";
                    msg.className = "text-red-600 text-sm";
                }
            });
        };

        // Poblado de Dropdowns Global
        window.populateDropdown = async function(collectionPath, elementId, itemName, selectedValue = null) {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = `<option value="">Cargando...</option>`;
            try {
                // Determinar ruta completa si es necesario
                const fullPath = collectionPath.startsWith('artifacts') ? collectionPath : `artifacts/${appId}/users/${userId}/${collectionPath}`;
                const snap = await getDocs(collection(db, fullPath));
                const items = snap.docs.map(d => d.data().name).sort((a,b) => a.localeCompare(b));
                select.innerHTML = `<option value="">Seleccione un ${itemName}</option>`;
                items.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name; opt.textContent = name;
                    if (name === selectedValue) opt.selected = true;
                    select.appendChild(opt);
                });
            } catch (err) {
                // Ignorar error si es por desconexión/permisos al salir
                if (err.code !== 'permission-denied') {
                    console.warn(`Error cargando dropdown ${itemName}:`, err);
                    select.innerHTML = `<option value="">Error al cargar</option>`;
                }
            }
        };

        // Pre-carga de datos para optimizar offline
        async function preloadAllData() {
            const collectionsToPreload = [
                { path: `artifacts/${appId}/users/${userId}/inventario` },
                { path: `artifacts/${appId}/users/${userId}/rubros` },
                { path: `artifacts/${appId}/users/${userId}/segmentos` },
                { path: `artifacts/${appId}/public/data/clientes` },
                { path: `artifacts/${appId}/public/data/sectores` },
                { path: `artifacts/${appId}/public/data/config/obsequio` }
            ];
            await Promise.allSettled(collectionsToPreload.map(col => {
                if (col.path.includes('/config/')) return getDoc(doc(db, col.path));
                return getDocs(collection(db, col.path));
            }));
        }

        // Vista Principal del Menú
        window.showMainMenu = function() {
            cleanupListeners();
            mainContent.classList.remove('hidden');
            floatingControls.classList.remove('hidden');
            document.body.classList.remove('catalogo-active');
            document.body.style.removeProperty('--catalogo-bg-image');
            const isAdmin = window.userRole === 'admin';

            mainContent.innerHTML = `
                <div class="p-4 pt-8 container mx-auto max-w-lg">
                    <div class="bg-white/90 backdrop-blur-sm p-8 rounded-lg shadow-xl text-center">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6">Menú Principal</h1>
                        <div class="space-y-4">
                            <button id="inventarioBtn" class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600">Inventario</button>
                            
                            <!-- Botón Edición Inventario (Solo Admin) -->
                            ${isAdmin ? `<button id="editInventarioBtn" class="w-full px-6 py-3 bg-amber-600 text-white rounded-lg shadow-md hover:bg-amber-700 font-bold">Edición de Inventario</button>` : ''}
                            
                            <button id="clientesBtn" class="w-full px-6 py-3 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600">Clientes</button>
                            <button id="ventasBtn" class="w-full px-6 py-3 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600">Ventas</button>
                            
                            <button id="cxcBtn" class="w-full px-6 py-3 bg-orange-500 text-white rounded-lg shadow-md hover:bg-orange-600 font-bold">CXC</button>
                            
                            ${!isAdmin ? `<button id="obsequiosBtn" class="w-full px-6 py-3 bg-cyan-500 text-white rounded-lg shadow-md hover:bg-cyan-600">Obsequios</button>` : ''}
                            <button id="catalogoBtn" class="w-full px-6 py-3 bg-purple-500 text-white rounded-lg shadow-md hover:bg-purple-600">Catálogo</button>
                            <button id="profileAdminBtn" class="w-full px-6 py-3 bg-gray-700 text-white rounded-lg shadow-md hover:bg-gray-800">${isAdmin ? 'Admin Panel' : 'Mi Perfil'}</button>
                            ${isAdmin ? `<button id="dataBtn" class="w-full px-6 py-3 bg-red-700 text-white rounded-lg shadow-md hover:bg-red-800">Data</button>` : ''}
                        </div>
                        <div class="mt-8 pt-4 border-t flex items-center justify-center space-x-3">
                             <span id="offline-toggle-text" class="text-sm font-medium text-gray-700">Online (Manual)</span>
                             <input type="checkbox" id="offline-toggle"/>
                             <label for="offline-toggle" class="cursor-pointer">Toggle</label>
                        </div>
                    </div>
                </div>
            `;

            // Listeners Seguros (Evita crashes si faltan módulos)
            const safeNav = (fn, name) => {
                if (typeof fn === 'function') {
                    floatingControls.classList.add('hidden'); 
                    fn();
                } else {
                    console.error(`Error de Navegación: El módulo '${name}' no está cargado.`);
                    window.showModal('Módulo no disponible', `La sección de ${name} no se ha podido cargar correctamente.`);
                }
            };

            document.getElementById('inventarioBtn')?.addEventListener('click', () => safeNav(window.showInventarioSubMenu, 'Inventario'));
            document.getElementById('editInventarioBtn')?.addEventListener('click', () => safeNav(window.showEditInventarioMenu, 'Edición Inventario'));
            document.getElementById('clientesBtn')?.addEventListener('click', () => safeNav(window.showClientesSubMenu, 'Clientes'));
            document.getElementById('ventasBtn')?.addEventListener('click', () => safeNav(window.showVentasView, 'Ventas'));
            document.getElementById('cxcBtn')?.addEventListener('click', () => safeNav(window.showCXCView, 'CXC'));
            document.getElementById('obsequiosBtn')?.addEventListener('click', () => safeNav(window.showGestionObsequiosView, 'Obsequios'));
            document.getElementById('catalogoBtn')?.addEventListener('click', () => safeNav(window.showCatalogoSubMenu, 'Catálogo'));
            document.getElementById('profileAdminBtn')?.addEventListener('click', () => safeNav(window.showAdminOrProfileView, 'Perfil/Admin'));
            document.getElementById('dataBtn')?.addEventListener('click', () => safeNav(window.showDataView, 'Data'));

            const toggle = document.getElementById('offline-toggle');
            toggle.checked = localStorage.getItem('manualOfflineMode') === 'true';
            toggle.addEventListener('change', async () => {
                manualOffline = toggle.checked;
                if (toggle.checked) {
                    await disableNetwork(db);
                    localStorage.setItem('manualOfflineMode', 'true');
                    updateConnectionDisplay(false);
                } else {
                    await enableNetwork(db);
                    localStorage.setItem('manualOfflineMode', 'false');
                    updateConnectionDisplay(navigator.onLine);
                }
            });

            // ELIMINADO: Listener a .info/connected que causaba el error de permisos en Firestore
        };

        async function initializeAppAndListeners() {
            const app = initializeApp(firebaseConfig);
            
            // 3. NUEVA INICIALIZACIÓN DE FIRESTORE CON PERSISTENCIA MODERNA (CORREGIDA)
            db = initializeFirestore(app, {
                localCache: persistentLocalCache() 
            });

            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                cleanupListeners();
                if (user) {
                    userId = user.uid;
                    const userDoc = await getDoc(doc(db, "users", userId));
                    window.userRole = userDoc.exists() ? userDoc.data().role : 'user';
                    
                    document.getElementById('loginContent').classList.add('hidden');
                    document.getElementById('registerContent').classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    mainContent.innerHTML = `<div class="p-8 text-center text-white font-bold text-xl">Sincronizando Base de Datos...</div>`;
                    
                    await preloadAllData();
                    
                    const deps = { 
                        db, userId, appId, mainContent, floatingControls, activeListeners, 
                        userRole: window.userRole, showMainMenu, showModal: window.showModal, 
                        showAddItemModal: window.showAddItemModal, populateDropdown: window.populateDropdown, 
                        collection, onSnapshot, doc, getDoc, addDoc, setDoc, deleteDoc, getDocs, 
                        writeBatch, runTransaction, query, where, orderBy, limit, startAfter, firebaseConfig,
                        increment 
                    };
                    
                    // Init de módulos con chequeo de seguridad
                    if (window.initData) window.initData(deps); else console.warn("Módulo Data no encontrado");
                    if (window.initAdmin) window.initAdmin(deps); else console.warn("Módulo Admin no encontrado");
                    if (window.initInventario) window.initInventario(deps); else console.warn("Módulo Inventario no encontrado");
                    if (window.initCatalogo) window.initCatalogo(deps); else console.warn("Módulo Catálogo no encontrado");
                    if (window.initClientes) window.initClientes(deps); else console.warn("Módulo Clientes no encontrado");
                    if (window.initVentas) window.initVentas(deps); else console.warn("Módulo Ventas no encontrado");
                    if (window.initObsequios) window.initObsequios(deps); else console.warn("Módulo Obsequios no encontrado");
                    if (window.initCXC) window.initCXC(deps); else console.warn("Módulo CXC no encontrado");
                    if (window.initEditInventario) window.initEditInventario(deps); else console.warn("Módulo Edit Inventario no encontrado");

                    showMainMenu();
                } else {
                    document.getElementById('loginContent').classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    floatingControls.classList.add('hidden');
                }
            });
        }

        function cleanupListeners() {
            activeListeners.forEach(u => { if(typeof u === 'function') u(); });
            activeListeners = [];
        }

        // Manejo de Forms
        loginForm?.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            signInWithEmailAndPassword(auth, email, pass).catch(err => {
                authMessage.textContent = "Correo o contraseña incorrectos.";
            });
        });

        registerForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmailInput').value;
            const pass = document.getElementById('registerPasswordInput').value;
            const confirm = document.getElementById('confirmPasswordInput').value;
            if (pass !== confirm) { registerMessage.textContent = "Las contraseñas no coinciden."; return; }
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", cred.user.uid), { email, role: 'user', createdAt: new Date() });
            } catch (err) { registerMessage.textContent = "Error al registrar."; }
        });

        document.getElementById('logoutBtn')?.addEventListener('click', () => {
            window.showModal('Cerrar Sesión', '¿Estás seguro?', () => signOut(auth));
        });

        document.getElementById('goToRegisterBtn')?.addEventListener('click', () => {
            loginContent.classList.add('hidden');
            registerContent.classList.remove('hidden');
        });

        document.getElementById('goToLoginBtn')?.addEventListener('click', () => {
            registerContent.classList.add('hidden');
            loginContent.classList.remove('hidden');
        });

        document.addEventListener('DOMContentLoaded', initializeAppAndListeners);

    </script>

    <!-- PWA REGISTER -->
    <script>
        if ('serviceWorker' in navigator) {
            // Solo registrar si estamos en HTTP/HTTPS (evita errores en preview)
            if (window.location.protocol.startsWith('http')) {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Error:', err));
            }
        }
    </script>
</body>
</html>
