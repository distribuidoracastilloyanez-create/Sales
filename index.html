<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n Dist. Castillo</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <!-- Estilos y Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- LIBRER√çAS EXCEL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <!-- Fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        /* Animaciones para modales */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        
        /* Fondo din√°mico para cat√°logo */
        body.catalogo-active {
            background-image: var(--catalogo-bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        /* Toggle Offline Personalizado */
        input[type="checkbox"]#offline-toggle { height: 0; width: 0; visibility: hidden; position: absolute; }
        label[for="offline-toggle"] { cursor: pointer; text-indent: -9999px; width: 44px; height: 24px; background: #4b5563; display: block; border-radius: 100px; position: relative; transition: background 0.3s; }
        label[for="offline-toggle"]:after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 90px; transition: 0.3s; }
        input:checked + label[for="offline-toggle"] { background: #dc2626; }
        input:checked + label[for="offline-toggle"]:after { left: calc(100% - 2px); transform: translateX(-100%); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Dist. Castillo</h1>
                <p class="text-gray-500 text-sm">Sistema de Gesti√≥n Integral</p>
            </div>

            <!-- Login Form -->
            <div id="login-content">
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                        <input type="email" id="emailInput" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none" placeholder="usuario@ejemplo.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="passwordInput" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div id="loginMessage" class="text-red-500 text-sm text-center h-5"></div>
                    <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition-all transform active:scale-95">
                        Iniciar Sesi√≥n
                    </button>
                </form>
                <div class="mt-6 text-center">
                    <button id="goToRegisterBtn" class="text-sm text-blue-600 hover:underline">¬øNo tienes cuenta? Reg√≠strate</button>
                </div>
            </div>

            <!-- Register Form (Oculto por defecto) -->
            <div id="register-content" class="hidden">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                        <input type="email" id="registerEmailInput" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                        <input type="password" id="registerPasswordInput" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contrase√±a</label>
                        <input type="password" id="confirmPasswordInput" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div id="registerMessage" class="text-red-500 text-sm text-center h-5"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md transition-all">
                        Registrarse
                    </button>
                </form>
                <div class="mt-6 text-center">
                    <button id="goToLoginBtn" class="text-sm text-blue-600 hover:underline">Volver al Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MAIN APP LAYOUT (Oculto hasta login) -->
    <div id="app-layout" class="hidden flex flex-col h-full">
        <!-- Top Navbar -->
        <header class="bg-blue-700 text-white shadow-md z-20 flex-shrink-0">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2" onclick="window.location.reload()"> 
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span class="font-bold text-lg tracking-wide">Dist. Castillo</span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Status Indicator (UNIFICADO) -->
                    <div id="connectionStatus" class="px-2 py-1 bg-green-500 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 text-white transition-colors duration-300">
                        <span id="connectionDot" class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        <span id="connectionText">Online</span>
                    </div>
                    
                    <!-- Role Badge -->
                    <div id="userRoleBadge" class="hidden md:block px-2 py-1 bg-blue-800 rounded text-xs text-blue-200 uppercase tracking-wider font-semibold border border-blue-600">
                        User
                    </div>

                    <!-- Logout -->
                    <button id="logoutBtn" class="p-2 hover:bg-blue-600 rounded-full transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow overflow-y-auto bg-gray-100 relative w-full">
            <!-- Dynamic Content Injected Here -->
            <div class="flex items-center justify-center h-full">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        </main>

        <!-- Floating Action Menu (Mobile/Desktop) -->
        <div id="floating-controls" class="fixed bottom-6 right-6 flex flex-col gap-3 z-30 transition-transform duration-300 hidden">
            <!-- Offline Toggle (Mejorado) -->
            <div class="bg-white p-2 rounded-full shadow-lg flex items-center space-x-2 pr-4">
                <input type="checkbox" id="offline-toggle"/>
                <label for="offline-toggle" class="cursor-pointer" title="Modo Offline Manual">Toggle</label>
                <span class="text-xs font-bold text-gray-600">Offline</span>
            </div>
        </div>
    </div>

    <!-- 3. MODAL CONTAINER (Global) -->
    <div id="modalContainer" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-200 scale-95 opacity-0" id="modalContentWrapper">
            <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-bold text-white tracking-wide">T√≠tulo</h3>
                <button id="modalCloseTop" class="text-white hover:text-gray-200 focus:outline-none">‚úï</button>
            </div>
            <div id="modalBody" class="p-6 max-h-[70vh] overflow-y-auto text-gray-700"></div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t">
                <button id="modalCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-medium transition-colors hidden">Cancelar</button>
                <button id="modalConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-transform active:scale-95">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS M√ìDULOS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="data.js" defer></script>
    <script src="admin.js" defer></script>
    <script src="inventario.js" defer></script>
    <script src="catalogo.js" defer></script>
    <script src="clientes.js" defer></script>
    <script src="ventas-ui.js" defer></script>
    <script src="ventas.js" defer></script>
    <script src="obsequios.js" defer></script>
    <script src="cxc.js" defer></script>
    <script src="edit-inventario.js" defer></script>

    <!-- FIREBASE & MAIN LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, deleteDoc, onSnapshot, collection, writeBatch, runTransaction, getDocs, enableIndexedDbPersistence, query, where, orderBy, limit, startAfter, enableNetwork, disableNetwork, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApyjf3NIjnGJp2sWyJccsR40-Q8UnU364",
            authDomain: "dist-castillo-sales.firebaseapp.com",
            projectId: "dist-castillo-sales",
            storageBucket: "dist-castillo-sales.firebasestorage.app",
            messagingSenderId: "719110919658",
            appId: "1:719110919658:web:7830a013c8c685a2c08e93"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId, userRole = 'user';
        let activeListeners = [];
        let manualOffline = localStorage.getItem('manualOfflineMode') === 'true';

        // --- SISTEMA DE ESTADO DE CONEXI√ìN UNIFICADO ---
        // Esta funci√≥n controla el UI de la barra superior.
        // source: 'network' (navegador) o 'firestore' (base de datos)
        function setConnectionState(isOnline, source = 'network') {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const dot = document.getElementById('connectionDot');
            
            // Si estamos en modo manual offline, forzar visualizaci√≥n roja
            if (manualOffline) {
                statusDiv.className = "px-2 py-1 bg-red-600 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 text-white";
                statusText.textContent = "Offline (Manual)";
                dot.classList.remove('animate-pulse', 'bg-white');
                dot.classList.add('bg-gray-300');
                return;
            }

            // L√≥gica normal
            if (isOnline) {
                statusDiv.className = "px-2 py-1 bg-green-500 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 text-white";
                statusText.textContent = "Online";
                dot.className = "w-2 h-2 bg-white rounded-full animate-pulse";
            } else {
                statusDiv.className = "px-2 py-1 bg-yellow-500 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 text-white";
                statusText.textContent = source === 'firestore' ? "Sin Conexi√≥n (Cache)" : "Sin Internet";
                dot.className = "w-2 h-2 bg-red-200 rounded-full";
            }
        }

        // Listeners Nativos
        window.addEventListener('online', () => { 
            if(!manualOffline) { enableNetwork(db); setConnectionState(true); } 
        });
        window.addEventListener('offline', () => setConnectionState(false));
        
        // Inicializaci√≥n inmediata (Feedback r√°pido al usuario)
        setConnectionState(navigator.onLine);

        // Persistencia
        enableIndexedDbPersistence(db).catch(err => {
            if (err.code == 'failed-precondition') console.warn('Persistencia fall√≥: M√∫ltiples pesta√±as.');
            else if (err.code == 'unimplemented') console.warn('Navegador no soporta persistencia.');
        });

        // Toggle Manual
        const toggleBtn = document.getElementById('offline-toggle');
        toggleBtn.checked = manualOffline;
        toggleBtn.addEventListener('change', async () => {
            manualOffline = toggleBtn.checked;
            localStorage.setItem('manualOfflineMode', manualOffline);
            if (manualOffline) {
                await disableNetwork(db);
                setConnectionState(false);
                window.showModal('Modo Offline', 'Datos locales activados. No se sincronizar√° hasta desactivar.');
            } else {
                await enableNetwork(db);
                setConnectionState(navigator.onLine);
                window.showModal('Modo Online', 'Sincronizando...');
            }
        });

        // --- SISTEMA DE MODALES ---
        window.showModal = function(title, contentHTML, onConfirm = null, confirmText = 'Aceptar', onCancel = null, triggerConfirmLogic = false) {
            const container = document.getElementById('modalContainer');
            const wrapper = document.getElementById('modalContentWrapper');
            const titleEl = document.getElementById('modalTitle');
            const bodyEl = document.getElementById('modalBody');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');
            const closeTop = document.getElementById('modalCloseTop');

            titleEl.textContent = title;
            // Detectar si es texto plano o HTML
            if (contentHTML.trim().startsWith('<')) bodyEl.innerHTML = contentHTML;
            else bodyEl.textContent = contentHTML;

            confirmBtn.textContent = confirmText;
            
            // Clonar botones para limpiar listeners viejos
            const newConfirm = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
            const newCancel = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
            const newCloseTop = closeTop.cloneNode(true);
            closeTop.parentNode.replaceChild(newCloseTop, closeTop);

            newConfirm.onclick = async () => {
                if (onConfirm) {
                    if (triggerConfirmLogic) {
                        newConfirm.disabled = true;
                        newConfirm.textContent = '...';
                        await onConfirm();
                    } else {
                        onConfirm();
                    }
                }
                closeModal();
            };

            if (onCancel || (confirmText !== 'Aceptar' && confirmText !== 'Cerrar')) {
                newCancel.classList.remove('hidden');
                newCancel.onclick = () => { if (onCancel) onCancel(); closeModal(); };
            } else {
                newCancel.classList.add('hidden');
            }
            
            newCloseTop.onclick = closeModal;

            function closeModal() {
                wrapper.classList.remove('scale-100', 'opacity-100');
                wrapper.classList.add('scale-95', 'opacity-0');
                setTimeout(() => container.classList.add('hidden'), 200);
            }

            container.classList.remove('hidden');
            setTimeout(() => {
                wrapper.classList.remove('scale-95', 'opacity-0');
                wrapper.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        // --- AUTH & APP FLOW ---
        const loginScreen = document.getElementById('login-screen');
        const appLayout = document.getElementById('app-layout');
        const mainContent = document.getElementById('main-content');
        const floatingControls = document.getElementById('floating-controls');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                loginScreen.classList.add('hidden');
                appLayout.classList.remove('hidden');
                
                try {
                    const userDoc = await getDoc(doc(db, "users", userId));
                    userRole = userDoc.exists() ? userDoc.data().role : 'user';
                    window.userRole = userRole;
                    document.getElementById('userRoleBadge').textContent = userRole === 'admin' ? 'ADMIN' : 'VENDEDOR';
                } catch (e) { console.error("Error fetching role (offline?)", e); }

                // Listener de Conexi√≥n Firestore (La fuente de verdad definitiva)
                const connectionUnsub = onSnapshot(doc(db, '.info/connected'), (snap) => {
                    if (!manualOffline) {
                        setConnectionState(snap.data()?.connected ?? false, 'firestore');
                    }
                });
                activeListeners.push(connectionUnsub);

                // Dependencias para m√≥dulos
                const deps = {
                    db, auth, userId, userRole, appId: "ventas-9a210",
                    mainContent, floatingControls, activeListeners,
                    showMainMenu, showModal: window.showModal,
                    collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, 
                    onSnapshot, query, where, orderBy, limit, startAfter, writeBatch, runTransaction, increment,
                    populateDropdown: window.populateDropdown, showAddItemModal: window.showAddItemModal
                };

                // Inicializar M√≥dulos
                if(window.initAdmin) window.initAdmin(deps);
                if(window.initData) window.initData(deps);
                if(window.initInventario) window.initInventario(deps);
                if(window.initCatalogo) window.initCatalogo(deps);
                if(window.initClientes) window.initClientes(deps);
                if(window.initVentas) window.initVentas(deps);
                if(window.initObsequios) window.initObsequios(deps);
                if(window.initCXC) window.initCXC(deps);
                if(window.initEditInventario) window.initEditInventario(deps);

                showMainMenu();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appLayout.classList.add('hidden');
                cleanupListeners();
            }
        });

        function showMainMenu() {
            floatingControls.classList.remove('hidden');
            document.body.classList.remove('catalogo-active');
            document.body.style.removeProperty('--catalogo-bg-image');
            
            mainContent.innerHTML = `
                <div class="p-6 pt-8 max-w-4xl mx-auto grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                    ${getMenuCard('üõí', 'Ventas', 'Nueva venta y cierres', 'showVentasTotales', 'bg-blue-600')}
                    ${getMenuCard('üì¶', 'Inventario', 'Productos y Stock', 'showInventarioMenu', 'bg-green-600')}
                    ${getMenuCard('üë•', 'Clientes', 'Cartera de clientes', 'showClientesMenu', 'bg-purple-600')}
                    ${getMenuCard('üìí', 'Cat√°logo', 'Generar im√°genes', 'showCatalogoMenu', 'bg-orange-500')}
                    ${getMenuCard('üí∞', 'CXC', 'Cuentas por Cobrar', 'showCXCMenu', 'bg-teal-600')}
                    ${getMenuCard('üéÅ', 'Obsequios', 'Control de regal√≠as', 'showObsequiosMenu', 'bg-pink-500')}
                    ${getMenuCard('üìä', 'Datos', 'Mapas y estad√≠sticas', 'showDataMenu', 'bg-indigo-600')}
                    ${getMenuCard('‚öôÔ∏è', 'Admin / Perfil', 'Configuraci√≥n', 'showAdminMenu', 'bg-gray-700')}
                </div>
            `;

            // Enrutamiento seguro
            const nav = (mod, fn) => {
                if(mod && typeof mod[fn] === 'function' || typeof window[fn] === 'function') {
                    if(window[fn]) window[fn](); else mod[fn]();
                } else {
                    window.showModal('Cargando...', 'El m√≥dulo a√∫n se est√° inicializando.');
                }
            };

            document.getElementById('card-Ventas').onclick = () => nav(window.ventasModule, 'showVentasTotalesView'); // Note: global function hook in UI file
            document.getElementById('card-Inventario').onclick = () => nav(window.inventarioModule, 'showInventarioSubMenu');
            document.getElementById('card-Clientes').onclick = () => nav(window.clientesModule, 'showClientesSubMenu');
            document.getElementById('card-Cat√°logo').onclick = () => nav(window.catalogoModule, 'showCatalogoSubMenu');
            document.getElementById('card-CXC').onclick = () => nav(window.cxcModule, 'showCXCView');
            document.getElementById('card-Obsequios').onclick = () => nav(window.obsequiosModule, 'showGestionObsequiosView');
            document.getElementById('card-Datos').onclick = () => nav(window.dataModule, 'showDataSubMenuView');
            document.getElementById('card-Admin / Perfil').onclick = () => nav(window.adminModule, 'showAdminOrProfileView');
        }

        function getMenuCard(icon, title, desc, action, color) {
            return `
                <div id="card-${title}" class="bg-white rounded-xl shadow-md p-4 flex flex-col items-center text-center cursor-pointer hover:shadow-xl hover:scale-105 transition-all border-b-4 ${color.replace('bg-', 'border-')} active:bg-gray-50">
                    <div class="w-12 h-12 ${color} rounded-full flex items-center justify-center text-2xl mb-3 shadow-sm text-white">${icon}</div>
                    <h3 class="font-bold text-gray-800 text-sm md:text-base">${title}</h3>
                    <p class="text-xs text-gray-500 mt-1 hidden md:block">${desc}</p>
                </div>
            `;
        }

        function cleanupListeners() {
            activeListeners.forEach(u => u && u());
            activeListeners = [];
        }

        // Helpers Globales para M√≥dulos (AddItem, Dropdowns)
        window.populateDropdown = async function(path, elId, label, selVal = null) {
            const el = document.getElementById(elId); if (!el) return;
            el.innerHTML = `<option value="">Cargando...</option>`;
            try {
                const snap = await getDocs(collection(db, path));
                const items = snap.docs.map(d => d.data().name).sort();
                el.innerHTML = `<option value="">${label}</option>` + items.map(n => `<option value="${n}" ${n===selVal?'selected':''}>${n}</option>`).join('');
            } catch(e) { el.innerHTML = `<option>Error</option>`; }
        };

        window.showAddItemModal = function(colName, title) {
            if (userRole !== 'admin') return window.showModal('Error', 'Solo administradores.');
            window.showModal(`Agregar ${title}`, 
                `<input type="text" id="newItemName" class="w-full border p-2 rounded uppercase" placeholder="Nombre">`,
                async () => {
                    const name = document.getElementById('newItemName').value.trim().toUpperCase();
                    if(name) {
                        try {
                            await addDoc(collection(db, `artifacts/ventas-9a210/users/${userId}/${colName}`), { name, createdAt: new Date() });
                            window.showModal('√âxito', 'Elemento agregado.');
                            if(window.adminModule?.propagateCategoryChange) window.showModal('Info', 'Sincroniza en Admin > Limpieza.');
                        } catch(e) { window.showModal('Error', e.message); }
                    }
                }, 'Guardar'
            );
        };

        // Login Logic
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passwordInput').value);
            } catch (e) { document.getElementById('loginMessage').textContent = "Error de credenciales"; }
        };
        
        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const p1 = document.getElementById('registerPasswordInput').value;
            const p2 = document.getElementById('confirmPasswordInput').value;
            if(p1!==p2) return document.getElementById('registerMessage').textContent = "Contrase√±as no coinciden";
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('registerEmailInput').value, p1);
                await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, role: 'user', createdAt: new Date() });
            } catch(e) { document.getElementById('registerMessage').textContent = "Error al registrar"; }
        };

        document.getElementById('logoutBtn').onclick = () => window.showModal('Cerrar Sesi√≥n', '¬øSalir?', () => signOut(auth));
        
        // Navegaci√≥n Login/Registro
        document.getElementById('goToRegisterBtn').onclick = () => { document.getElementById('loginContent').classList.add('hidden'); document.getElementById('registerContent').classList.remove('hidden'); };
        document.getElementById('goToLoginBtn').onclick = () => { document.getElementById('registerContent').classList.add('hidden'); document.getElementById('loginContent').classList.remove('hidden'); };

    </script>

    <!-- PWA Register -->
    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(console.error);
    </script>
</body>
</html>
