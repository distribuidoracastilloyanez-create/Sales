<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas - Dist. Castillo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Evitar scroll horizontal en móviles */
        html, body { overflow-x: hidden; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-20">
        
        <!-- Header Principal -->
        <header id="mainHeader" class="bg-blue-600 text-white p-4 sticky top-0 z-40 hidden">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold" id="viewTitle">Panel Principal</h1>
                <button id="menuBtn" class="p-2 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m4 6h16"></path></svg>
                </button>
            </div>
        </header>

        <!-- Overlay de Carga -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 font-medium italic">Iniciando sistema...</p>
        </div>

        <!-- Sección de Autenticación -->
        <div id="authContainer" class="p-8 pt-20 hidden">
            <div id="loginView">
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-black text-blue-600">DIST. CASTILLO</h2>
                    <p class="text-gray-400 text-sm tracking-widest">SISTEMA DE VENTAS</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Email</label>
                        <input type="email" id="loginEmail" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase ml-1">Contraseña</label>
                        <input type="password" id="loginPassword" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition">INGRESAR</button>
                </form>
                <div class="mt-8 text-center">
                    <button id="goToRegisterBtn" class="text-sm text-blue-500 font-medium">¿Solicitar acceso? <span class="font-bold underline">Regístrate</span></button>
                </div>
            </div>

            <div id="registerView" class="hidden">
                <h2 class="text-3xl font-bold text-center mb-8 text-blue-600">Registro</h2>
                <form id="registerForm" class="space-y-4">
                    <input type="email" id="registerEmail" placeholder="Correo corporativo" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <input type="password" id="registerPassword" placeholder="Contraseña segura" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition">CREAR CUENTA</button>
                </form>
                <button id="goToLoginBtn" class="w-full mt-4 text-gray-500 text-sm font-bold">Volver al Login</button>
            </div>
        </div>

        <!-- Contenido de los Módulos JS -->
        <main id="mainContent" class="p-4 hidden"></main>

        <!-- Barra de Navegación -->
        <div id="floatingControls" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t p-2 flex justify-around items-center z-40 hidden">
            <button id="homeBtn" class="p-2 flex flex-col items-center text-blue-600 transition hover:bg-blue-50 rounded-lg px-4">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                <span class="text-[10px] font-bold uppercase mt-1">Inicio</span>
            </button>
            <button id="logoutBtn" class="p-2 flex flex-col items-center text-red-400 transition hover:bg-red-50 rounded-lg px-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span class="text-[10px] font-bold uppercase mt-1">Cerrar</span>
            </button>
        </div>
    </div>

    <!-- Modal Universal -->
    <div id="modalContainer" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl scale-up-animation">
            <div id="modalHeader" class="p-4 border-b bg-gray-50/50 flex justify-between items-center">
                <h3 id="modalTitle" class="font-bold text-gray-800">Mensaje</h3>
            </div>
            <div id="modalContent" class="p-6 text-gray-600 max-h-[70vh] overflow-y-auto text-sm leading-relaxed"></div>
            <div id="modalFooter" class="p-4 border-t flex justify-end space-x-3 bg-gray-50/50">
                <button id="modalCloseBtn" class="px-5 py-2 text-gray-500 font-semibold text-sm rounded-xl hover:bg-gray-200 transition">Cerrar</button>
                <button id="modalActionBtn" class="px-5 py-2 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 shadow-md transition hidden">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Carga de archivos de lógica -->
    <script src="data.js"></script>
    <script src="inventario.js"></script>
    <script src="clientes.js"></script>
    <script src="ventas.js"></script>
    <script src="obsequios.js"></script>
    <script src="catalogo.js"></script>
    <script src="admin.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, 
            onSnapshot, query, where, deleteDoc, writeBatch, runTransaction,
            orderBy, limit, startAfter
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Configuración de tu nuevo proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyApyjf3NIjnGJp2sWyJccsR40-Q8UnU364",
            authDomain: "dist-castillo-sales.firebaseapp.com",
            projectId: "dist-castillo-sales",
            storageBucket: "dist-castillo-sales.firebasestorage.app",
            messagingSenderId: "719110919658",
            appId: "1:719110919658:web:7830a013c8c685a2c08e93",
            measurementId: "G-VJWMMH9FQC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Variables de Control que tus módulos necesitan
        const appId = "dist-castillo-sales";
        const activeListeners = []; // Fundamental para evitar procesos duplicados

        // Elementos UI
        const mainContent = document.getElementById('mainContent');
        const authContainer = document.getElementById('authContainer');
        const floatingControls = document.getElementById('floatingControls');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainHeader = document.getElementById('mainHeader');

        /**
         * Función Modal Global
         * Tus archivos .js la llaman constantemente.
         */
        window.showModal = function(title, content, actionCallback = null, actionText = 'Confirmar', isDangerous = false) {
            const container = document.getElementById('modalContainer');
            const titleEl = document.getElementById('modalTitle');
            const contentEl = document.getElementById('modalContent');
            const actionBtn = document.getElementById('modalActionBtn');
            const closeBtn = document.getElementById('modalCloseBtn');

            titleEl.textContent = title;
            if (typeof content === 'string') {
                contentEl.innerHTML = `<p>${content}</p>`;
            } else {
                contentEl.innerHTML = '';
                contentEl.appendChild(content);
            }

            if (actionCallback) {
                actionBtn.classList.remove('hidden');
                actionBtn.textContent = actionText;
                actionBtn.className = isDangerous 
                    ? 'px-5 py-2 bg-red-600 text-white font-bold text-sm rounded-xl hover:bg-red-700 transition'
                    : 'px-5 py-2 bg-blue-600 text-white font-bold text-sm rounded-xl hover:bg-blue-700 transition';
                
                actionBtn.onclick = () => {
                    actionCallback();
                    container.classList.add('hidden');
                };
            } else {
                actionBtn.classList.add('hidden');
            }

            closeBtn.onclick = () => container.classList.add('hidden');
            container.classList.remove('hidden');
        };

        /**
         * Inyección de Dependencias
         * Aquí pasamos todas las funciones que antes estaban en el objeto global.
         */
        function injectModuleDependencies(user, role) {
            const deps = {
                // Firebase Core
                db, auth, 
                // Firestore Funcs
                collection, doc, getDoc, setDoc, addDoc, getDocs, 
                onSnapshot, query, where, deleteDoc, writeBatch, runTransaction, 
                orderBy, limit, startAfter,
                // App State
                userId: user.uid,
                userRole: role,
                appId: appId,
                activeListeners: activeListeners, // Mantenemos compatibilidad con listeners
                // UI Bridge
                mainContent: mainContent,
                floatingControls: floatingControls,
                showMainMenu: showMainView,
                showModal: window.showModal,
                // Helpers compartidos
                populateDropdown: window.populateDropdown || null,
                showAddItemModal: window.showAddItemModal || null
            };

            // Ejecutamos los inicializadores de cada archivo .js cargado
            if (window.initData) window.initData(deps);
            if (window.initInventario) window.initInventario(deps);
            if (window.initClientes) window.initClientes(deps);
            if (window.initVentas) window.initVentas(deps);
            if (window.initObsequios) window.initObsequios(deps);
            if (window.initCatalogo) window.initCatalogo(deps);
            if (window.initAdmin) window.initAdmin(deps);
        }

        /**
         * Control de Vistas Principal
         */
        async function showMainView(user) {
            loadingOverlay.classList.remove('hidden');
            authContainer.classList.add('hidden');
            
            // Verificamos el rol del usuario en la nueva base de datos
            let role = 'vendedor';
            try {
                const profileRef = doc(db, `artifacts/${appId}/users/${user.uid}/config/profile`);
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    role = profileSnap.data().role || 'vendedor';
                } else {
                    // Si no existe, lo creamos para evitar errores
                    await setDoc(profileRef, { email: user.email, role: 'vendedor', createdAt: new Date() });
                }
            } catch (e) { 
                console.warn("No se pudo leer el rol, usando default."); 
            }

            injectModuleDependencies(user, role);
            
            mainHeader.classList.remove('hidden');
            floatingControls.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            loadingOverlay.classList.add('hidden');

            // Cargamos el menú principal desde admin.js o data.js
            if (window.renderMainMenu) {
                window.renderMainMenu();
            } else if (window.renderDashboard) {
                window.renderDashboard();
            }
        }

        function showLoginView() {
            authContainer.classList.remove('hidden');
            mainHeader.classList.add('hidden');
            floatingControls.classList.add('hidden');
            mainContent.classList.add('hidden');
            loadingOverlay.classList.add('hidden');
        }

        // Manejo de Auth
        onAuthStateChanged(auth, (user) => {
            if (user) showMainView(user);
            else showLoginView();
        });

        // Eventos de Formulario
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                window.showModal('Error de Acceso', 'Verifica tus credenciales: ' + err.message);
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const pass = document.getElementById('registerPassword').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                window.showModal('Error de Registro', err.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.showModal('Cerrar Sesión', '¿Deseas salir del sistema?', () => signOut(auth));
        });

        document.getElementById('homeBtn').addEventListener('click', () => {
            if (window.renderMainMenu) window.renderMainMenu();
        });

        document.getElementById('goToRegisterBtn').addEventListener('click', () => {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('registerView').classList.remove('hidden');
        });

        document.getElementById('goToLoginBtn').addEventListener('click', () => {
            document.getElementById('registerView').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
        });

        // Registro de Service Worker para modo Offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW activo'))
                    .catch(err => console.log('SW error', err));
            });
        }
    </script>
</body>
</html>
